<!DOCTYPE html>
<style>#log { white-space: pre; }</style>
<script src="webrtc-connection.js"></script>
<div id="log"></div>
<script>

function log(text) {
  document.getElementById('log').textContent += text + '\n';
}

function ping(connection, timeout) {
  return new Promise((resolve, reject) => {
    let start = performance.now();
    let timer = setTimeout(function() {
      connection.removeEventListener('message', onmessage);
      reject();
    }, timeout);
    function onmessage(evt) {
      connection.removeEventListener('message', onmessage);
      clearTimeout(timer);
      resolve(performance.now() - start);
    }
    connection.addEventListener('message', onmessage);
    connection.send('ping');
  });
}

async function test() {
  let start = performance.now();
  let conn = await WebRTCConnection.establish(new WebSocket(location.origin.replace('http', 'ws') + '/echo'));
  let duration = performance.now() - start;
  log('Connection established in ' + duration + 'ms');
  for (let i = 0; i < 10; i++) {
    try {
      let pingTime = await ping(conn, 1000);
      log('Ping ' + i + ' received in ' + pingTime + 'ms');
    } catch(err) {
      log('Ping ' + i + ' lost');
    }
  }
  conn.close();
}

test();
</script>
